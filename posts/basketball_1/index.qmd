---
title: "How Efficient is Basketball?"
date: "2/22/2022"
author: "Rich Bingham"
description: "Basketball has a lot of close games, but how often do good teams need to come from behind to win?"
format: html
editor: source
bibliography: references.bib
categories:
  - Basketball
  - NBA
---

```{r}
#| include: false
library(ggplot2)
library(dplyr)
library(readr)
library(gridExtra)
all_seasons_times <- read_csv("all_seasons_game_logs_plus.csv")
all_seasons_info <- read_csv("all_seasons_info.csv")
IvC <- read_csv("Ind_Cle_2025_ECSF_2.csv")

team_colours <-   c("Atlanta Hawks" = "#c1d32f", "Boston Celtics" = "#007a33",
                    "Brooklyn Nets" = "#000000", "Charlotte Hornets" = "#1d1160",
                    "Chicago Bulls" = "#ce1141", "Cleveland Cavaliers" = "#860038",
                    "Dallas Mavericks" = "#00538c","Denver Nuggets" = "#0e2240",
                    "Detroit Pistons" = "#c8102e","Golden State Warriors" = "#1d428a",
                    "Houston Rockets" = "#ba0c2f","Indiana Pacers" = "#fdbb30",
                    "LA Clippers" = "#bec0c2","Los Angeles Lakers" = "#f9a01b",
                    "Memphis Grizzlies" = "#5d76a9","Miami Heat" = "#98002e",
                    "Milwaukee Bucks" = "#00471b", "Minnesota Timberwolves" = "#0c2340",
                    "New Orleans Pelicans" = "#85714d","New York Knicks" = "#f58426",
                    "Oklahoma City Thunder" = "#007ac1","Orlando Magic" = "#0077c0",
                    "Philadelphia 76ers" = "#006bb6","Phoenix Suns" = "#1d1160",
                    "Portland Trail Blazers" ="#e03a3e", "Sacramento Kings" = "#5a2d81",
                    "San Antonio Spurs" = "#c4ced4","Toronto Raptors" = "#a1a1a4",
                    "Utah Jazz" = "#753bbd","Washington Wizards" = "#002b5c")

```

## Frequent Scoring, Close Games

Basketball is one of the youngest widely played team sports in the world. Over its short history it has grown from its roots in the YMCA to global popularity, with even derivative forms being played as Olympic competition. There have been several developments that have reformed the game, such as the introduction of the shot clock, the three point line and liberalisation of the rules regarding dunking. A feature practically unique to basketball however is the common occurrence of high-scoring, but still close, games. In a game both teams often score more than 100 points each while the final winning margin will be less than 3 points, meaning that the outcome could have been reversed by one more scoring event. Between the 2016-17 and the 2024-25 season, both teams scored more than 100 in 65% of the 10,740 games played. 18% of these high-scoring games finished within 3 points. Last-gasp winners exist in many sports, but not many of these last-gasp winners are only the last of (on average) 116 equivalent events.

While similar scoring dynamics are present in games like tennis or badminton, in those sports the aim is to reach a certain point total, rather than scoring the most points within a given time period. Rugby matches can have the similar turnarounds, but the number of scoring events is much lower. Time-limited close games certainly lead to exciting contests.

{{< video https://www.youtube.com/watch?v=greStrG8iVA >}}

This dynamic does suggest that the game is sometimes won by whichever team scores last. Given the rapid turnovers of possessions in a basketball game, could the outcome be a 50/50 coin toss? Obviously this is an oversimplification, as some teams can win games consistently, with the Golden State Warriors & the Boston Celtics both consistently producing high winning percentages in recent years. In close games, the final seconds of game time can often be extended by breaks in play such as timeouts and the efficient use of this 'clock control' is often cited as a key factor in successful teams.

If basketball can often be decided by which team scores last, does the \`best' team always win the championship? Are the most successful teams rewarded with spots in the playoffs? Given that the ultimate aim is to reach the playoffs and win the championship, in some ways the answer to the last two questions is always yes. En route to the NBA finals in the 2024-25 season, the Indiana Pacers won three games in the playoffs where they trailed going into the final minute. The eastern conference semifinal against the Cleveland Cavaliers was particularly notable; the Pacers trailed from midway through the first quarter before finally regaining the lead with one second left in the game. While many sports have such exciting last-gasp reversals, the high-scoring nature of basketball raises the question, how often do teams dominate scoring while losing games? This in turn brings up a larger question, is basketball 'efficient'? Is there an inherent nature of the games and competition structure that rewards dominating games less than expected? To address these questions we will need both game and season data.

## Dominating Games & Last Minute Winners

Each basketball game generates a wealth of data, much of which is publicly accessible in recent years. Play-by-play game logs can be insightful as these record all distinct actions in a game, such as fouls or scoring events. From these game logs we can reconstruct any derived statistics on a per-game basis. Below is the scoring differential of that eastern conference semifinal between Indiana and Cleveland.

```{r}
#| include: false

IvC <- IvC %>% mutate(hsd = home_score - lag(home_score)) %>%
  mutate(scoring_team = if_else(hsd > 0,"CLE","IND"))
```

```{r}
#| echo: false
#| warning: false

ggplot(IvC,aes(x=time2,y=diff))+
  annotate("rect",xmin=0,xmax=720,ymin=-Inf,ymax=Inf,fill="ivory3",alpha=0.2)+
  annotate("rect",xmin=1440,xmax=2160,ymin=-Inf,ymax=Inf,fill="ivory3",alpha=0.2)+
  annotate("text",x=360,y=-16,label="1st")+
  scale_x_continuous(limits=c(0,2910),expand=c(0,0),breaks = c(0,720,1440,2160,2880),labels =c("Game Start","1st Q End","Half","3rd Q End"," Game End"))+
  scale_y_continuous(limits=c(-7.5,22.5),expand=c(0,0))+
  theme_linedraw()+
  geom_hline(yintercept = 0,colour="black",linewidth=1,linetype=3)+
  geom_area(data = IvC %>% filter(diff >= 0),aes(x=time2,y=diff),fill="#86003840")+
  geom_area(data = IvC %>% filter(diff <= 0,time2<1000),aes(x=time2,y=diff),fill="#fdbb3080")+
  geom_line(data=IvC,aes(x=time2,y=diff),color="grey30",linewidth=1.2)+
  coord_cartesian(ylim = c(-7.5, 22.5), clip = 'on')+
  geom_point(aes(color=factor(scoring_team)),size=4.0)+geom_point(color="gray30",shape=1,size=4.0)+
  scale_color_manual(values= c("#860038","#fdbb30"))+
  geom_label(data=IvC[1,],aes(x=340,y=12),label="Cavs Leading",colour="#860038",size=4)+
  geom_label(data=IvC[1,],aes(x=2160,y=-5),label="Pacers Leading",colour="#fdbb30",size=4)+
  labs(x=NULL,y="Score Difference")+
  theme(legend.position="none",
        axis.text.x = element_text(size=12),
        axis.text.y = element_text(size=12),
        axis.title.y = element_text(size=12),
        plot.margin = margin(10,40,10,10)
        )

```

We can see that Cleveland were ahead for the vast majority of the game, after a short period of Indiana leading at the start. The deciding part however came with only three seconds to go, when the Pacers' point guard Haliburton launched a successful 3-pt shot turning a 117-119 loss into a 120-199 win. While the result is obviously decided by the score at the end of play, Indiana were only leading for 7% of the total game time, compared to 88% for Cleveland (the remaining \~5% the score was even) so were the Pacers really the 'better' team? 88% is a lot of the game to lead and still lose. Do successful teams avoid what happened to Cleveland? Do they regularly come from behind as Indiana did?

To look into these questions we will use the game logs from the 2016-17 to the 2024-25 seasons. This covers 11,534 games in total, including 10755 regular season games. We will focus on the regular season games to ensure all teams have a comparable number of games in the dataset. To see how out of the ordinary Cleveland's loss was, we calculate the fraction each team spends ahead/behind in a game, classifying these by whether they win or lose. Below we see the distribution of how long teams which lose have spent leading games. There is obviously a large peak at 0 for very one-sided games, but we can see a long tail all the way up to nearly 100% - the longest a team has lead the game and lost in this period is Clippers vs Wizards from January 2022, where the Clippers first took the lead with less than two seconds remaining. We can now see that Cleveland's failure to complete a dominant win was unusual - only 79 games of the 10,740 analysed (15 games were dropped due to incomplete data) had a team who had longer in the lead, but went on to lose. That's 0.74%, meaning this game would be in the top 1% of dominant losses.

```{r}
#| echo: false
#| warning: false

ggplot(data = all_seasons_times,aes(x=100*lose_time_in_front))+
  geom_histogram(binwidth = 1,color="grey30",fill="#fdbb3080")+
  xlim(-0.5,100)+theme_light()+
  labs(y="Frequency",x="Losing Team Time in Front (% of game time)")+
  scale_x_continuous(expand=c(0.008,0),breaks = seq(0,100,10))+scale_y_continuous(expand = c(0.008,0))
  
  

```

The time spent behind in a win is the mirror of this distribution, as expected. The reverse measure, the time spent leading in games won shows a similar distribution, although the peak at 99% is smaller - it's harder to dominate games than lose them comprehensively. Time spent in a tie is not counted in either statistic, so 0% time in front in a loss could include long stretches of tied game.

```{r}
#| echo: false
#| warning: false

ggplot(data = all_seasons_times,aes(x=100*win_time_in_front))+
  geom_histogram(binwidth = 1,color="grey30",fill="#86003840")+
  xlim(-0.5,100)+theme_light()+
  labs(y="Frequency",x="Winning Team Time in Front (% of game time)")+
  scale_x_continuous(expand=c(0.008,0),breaks = seq(0,100,10))+scale_y_continuous(expand = c(0.008,0))

```

Using these distributions of data from the 9 seasons analysed we could label certain games according to their position in the distribution. We have labelled losses from the top 10 percentile of losing time in front as "dominant defeats", which indicates that the losing team spent at least 61.5% of the game leading, while we also label wins from the bottom 10 percentile of winning time in front (also 61.5%) as "unlikely wins". The plots below show each teams unlikely winds and dominant defeats across the 9 seasons. Comparing these to win percentage, we can see that generally more successful teams do have more unlikely wins (filled circles) than dominant defeats (open circles), although it is far from a distinct trend and the overall number of these games is comparable between teams and seasons.

```{r}
#| echo: false
#| warning: false
#| fig-height: 8


ggplot(data = all_seasons_info)+geom_linerange(aes(xmin = ndd,xmax=nuw,y=winpercent,color=team))+facet_wrap(.~year)+geom_point(aes(x=ndd,y=winpercent,color=team),pch=21,fill="white")+geom_point(aes(x=nuw,y=winpercent,fill=team,color=team),pch=21)+theme_light()+labs(x="Number of Games",y="Win Percentage")+scale_x_continuous(breaks=c(0,2,4,6,8,10,12))+scale_color_manual(values=team_colours)+scale_fill_manual(values = team_colours)+theme(legend.position = "bottom",legend.title=element_blank())+guides(col = guide_legend(nrow = 8))
```

We have seen that the extreme cases of dominant defeats and unlikely wins aren't strong indicators of a teams success, but how do the measures that defined these games work out over a season? Do the teams that led for the longest in games have the highest win percentage? We can examine the correlations to find out.

```{r}
#| echo: false
#| warning: false

p1 <- ggplot(data = all_seasons_info,aes(x=avg_wtif,y=winpercent,color=team))+geom_point()+geom_smooth(aes(x=avg_wtif,y=winpercent),method=lm,inherit.aes = FALSE,se=FALSE,color="springgreen2")+scale_color_manual(values = team_colours)+theme_light()+theme(legend.position = "none")+
  annotate("text", x = 55, y = 70,parse=TRUE, label =as.character(expression(italic(rho) == 0.56)))+labs(y="Win Percentage",x="Average Winning Time in Front" )
p2 <- ggplot(data = all_seasons_info,aes(x=sd_wtif,y=winpercent,color=team))+geom_point()+geom_smooth(aes(x=sd_wtif,y=winpercent),method=lm,inherit.aes = FALSE,se=FALSE,color="violetred3")+scale_color_manual(values = team_colours)+theme_light()+theme(legend.position = "none")+
  annotate("text", x = 33, y = 75,parse=TRUE, label =as.character(expression(italic(rho) == -0.28)))+labs(y="Win Percentage",x="St. Dev. Winning Time in Front")
p3 <- ggplot(data = all_seasons_info,aes(x=avg_ltif,y=winpercent,color=team))+geom_point()+geom_smooth(aes(x=avg_ltif,y=winpercent),method=lm,inherit.aes = FALSE,se=FALSE,color="springgreen2")+scale_color_manual(values = team_colours)+theme_light()+theme(legend.position = "none")+
  annotate("text", x = 15, y = 70,parse=TRUE, label =as.character(expression(italic(rho) == 0.52)))+labs(y="Win Percentage",x="Average Losing Time in Front")
p4 <- ggplot(data = all_seasons_info,aes(x=sd_ltif,y=winpercent,color=team))+geom_point()+geom_smooth(aes(x=sd_ltif,y=winpercent),method=lm,inherit.aes = FALSE,se=FALSE,color="springgreen2")+scale_color_manual(values = team_colours)+theme_light()+theme(legend.position = "none")+
  annotate("text", x = 30, y = 28,parse=TRUE, label =as.character(expression(italic(rho) == 0.55)))+labs(y="Win Percentage",x="St. Dev. Losing Time in Front")

grid.arrange(p1,p2,p3,p4,nrow=2)

```

The average winning time (averaged per season for each team) in front has a positive correlation with win percentage as expected, given that winning teams will spend longer in front. The standard deviation of the winning time in front has negative correlation with the win percentage, meaning that winning teams more consistently dominate games. The losing time in front also has a positive (but weaker) correlation with the win percentage, as winning teams will still hold the lead in games they have lost. Interestingly, the standard deviation of the losing time in front has a positive correlation with the win percentage, which is caused by more successful teams having more losses where they lead for significant periods.

The measures we have considered so far are all continuous measures, but the outcomes that a team desires are all binary outcomes - you either win the championship or you don't, make the postseason or don't. We can compare how well the continuous variables predict binary outcomes using a technique called Binomial Regression.

## Binomial Regression

Binomial Regression fits a logistic model (an S-shaped, sigmoidal curve) using the continuous explanatory variables to predict the binary response variable. This then yields a probability of the outcome for each value of the explanatory variable. We can see how this works using the win percentage to see how well this predicts the probability of a team making the postseason.

```{r}
#| echo: false
#| warning: false

ggplot()+
    geom_point(data = all_seasons_info,aes(x=winpercent,y=as.numeric(post_season),color=team))+geom_smooth(data = all_seasons_info,aes(x=winpercent,y=as.numeric(post_season)),method=glm,method.args=list(family="binomial"),inherit.aes = FALSE,se=FALSE,color="#60606080",linewidth=2)+scale_color_manual(values = team_colours)+theme_light()+theme(legend.position = "none")+labs(x="Win Percentage",y="Postseason Prob.")+scale_y_continuous(breaks = c(0,0.5,1))


```

The points in this plot represent the final league win percentage of teams over the past 9 seasons, offset according to whether the team qualified for the postseason in that year. Points with a postseason prob at 1 made the postseason, while those at 0 missed out. Binomial Regression generates the grey curve which describes how we could predict a team's postseason likelihood given its win percentage, based upon the previous seasons. The curve is fitted using two parameters; the 'slope' and the intercept. The intercept can be considered as the residual chance of making the playoffs when the team wins no games. In this case, the intercept is 2.4E-9, meaning a team winning no games has about a 1 in 400 million chance of making the postseason. The 'slope' is 1.5, which means that the odds ratio (given by p/(1-p)) of making the postseason increase by 1.5 for each percentage point increase in win percentage. We can also calculate that the tipping point at which making the postseason is more likely than not (i.e. 50% probability) is a 48% win percentage. A win percentage above 54% gives a 90% chance of making the postseason. We can also determine how unlikely the outliers we see in this data are - the highest win percentage not to make the postseason belongs to the '18 Denver Nuggets with 56%. This would normally give a 96% chance of making the postseason, equal to 26 to 1 in favour! The '22 Spurs made the postseason with a winning percentage of 41%, which would normally give them a 5% chance, or 19 to 1 against. Qualification for the postseason in basketball depends on a teams position within the division rather than win percentage only, and these statistics highlight how the divisional system can be a mixed bag.

Reaching the postseason is obviously not the only outcome teams strive for each year, the playoffs have multiple stages, so we should consider how well win percentage predicts these outcomes. We can also compare them to the new measure of game dominance that we have derived, the average winning/losing time in front.

```{r}
#| echo: false
#| warning: false
#| fig-height: 9

lr1 <- ggplot()+
    geom_point(data = all_seasons_info,aes(x=winpercent,y=as.numeric(second_round),color=team))+geom_smooth(data = all_seasons_info,aes(x=winpercent,y=as.numeric(second_round)),method=glm,method.args=list(family="binomial"),inherit.aes = FALSE,se=FALSE,color="#60606080",linewidth=2)+scale_color_manual(values = team_colours)+theme_light()+theme(legend.position = "none")+labs(x="Win Percentage",y="Conf. Semifinals Prob.")+scale_y_continuous(breaks = c(0,0.5,1))

lr2 <- ggplot()+
    geom_point(data = all_seasons_info,aes(x=winpercent,y=as.numeric(conf_win),color=team))+geom_smooth(data = all_seasons_info,aes(x=winpercent,y=as.numeric(conf_win)),method=glm,method.args=list(family="binomial"),inherit.aes = FALSE,se=FALSE,color="#60606080",linewidth=2)+scale_color_manual(values = team_colours)+theme_light()+theme(legend.position = "none")+labs(x="Win Percentage",y="Conf. Finals Prob.")+scale_y_continuous(breaks = c(0,0.5,1))

lr3 <- ggplot()+
    geom_point(data = all_seasons_info,aes(x=winpercent,y=as.numeric(finals),color=team))+geom_smooth(data = all_seasons_info,aes(x=winpercent,y=as.numeric(finals)),method=glm,method.args=list(family="binomial"),inherit.aes = FALSE,se=FALSE,color="#60606080",linewidth=2)+scale_color_manual(values = team_colours)+theme_light()+theme(legend.position = "none")+labs(x="Win Percentage",y="NBA Finals Prob.")+scale_y_continuous(breaks = c(0,0.5,1))

lr4 <- ggplot()+
    geom_point(data = all_seasons_info,aes(x=winpercent,y=as.numeric(title_win),color=team))+geom_smooth(data = all_seasons_info,aes(x=winpercent,y=as.numeric(title_win)),method=glm,method.args=list(family="binomial"),inherit.aes = FALSE,se=FALSE,color="#60606080",linewidth=2)+scale_color_manual(values = team_colours)+theme_light()+theme(legend.position = "none")+labs(x="Win Percentage",y="NBA Title Prob.")+scale_y_continuous(breaks = c(0,0.5,1))


grid.arrange(lr1,lr2,lr3,lr4,nrow=4)

```

As the teams progress further in the postseason, the model represented by the grey line is less confident in predicting success based upon the win percentage, which we can see as the logistic curve does not reach p=1 for the conference finals and beyond. A win percentage above 72% will give the team a 99% chance of making the conference semifinals, whereas a win percentage above 97% is required to give a similar level of confidence of a conference finals appearance. A win percentage above 77% is needed to give a 'better than not' (probability above 0.5) chance of making the NBA finals (above 78% is needed for the same level of confidence in an NBA title win). This has only been observed in six teams across the 9 years analysed, and three of those teams won the NBA title. Whereas each percentage point increase in win percentage increases a teams odds of making the postseason by 1.5, the odds of making the NBA finals only increase by 1.15. This means increasing the win percentage from 50% to 60% increases the odds of making the post season from 2 to 1 in favour to 133 to 1 in favour, but only shifts the odds of making the finals from 54 to 1 against to 12 to 1 against. At each stage we can use an ANOVA with a likelihood ratio test to determine if our model is appropriate for the data and significantly improves over the null hypotheses. All of the models used here meet this requirement.

We can replace win percentage with the average winning time in front to see how efficiently that works as a predictor of postseason success.

```{r}
#| echo: false
#| warning: false
#| fig-height: 10

lr5 <- ggplot()+
    geom_point(data = all_seasons_info,aes(x=avg_wtif ,y=as.numeric(post_season),color=team))+geom_smooth(data = all_seasons_info,aes(x=avg_wtif,y=as.numeric(post_season)),method=glm,method.args=list(family="binomial"),inherit.aes = FALSE,se=FALSE,color="#60606080",linewidth=2)+scale_color_manual(values = team_colours)+theme_light()+theme(legend.position = "none")+labs(x="Average Winning Time in Front",y="Postseason Prob.")+scale_y_continuous(breaks = c(0,0.5,1))

lr6 <- ggplot()+
    geom_point(data = all_seasons_info,aes(x=avg_wtif,y=as.numeric(second_round),color=team))+geom_smooth(data = all_seasons_info,aes(x=avg_wtif,y=as.numeric(second_round)),method=glm,method.args=list(family="binomial"),inherit.aes = FALSE,se=FALSE,color="#60606080",linewidth=2)+scale_color_manual(values = team_colours)+theme_light()+theme(legend.position = "none")+labs(x="Average Winning Time in Front",y="Conf. Semifinals Prob.")+scale_y_continuous(breaks = c(0,0.5,1))

lr7 <- ggplot()+
    geom_point(data = all_seasons_info,aes(x=avg_wtif,y=as.numeric(conf_win),color=team))+geom_smooth(data = all_seasons_info,aes(x=avg_wtif,y=as.numeric(conf_win)),method=glm,method.args=list(family="binomial"),inherit.aes = FALSE,se=FALSE,color="#60606080",linewidth=2)+scale_color_manual(values = team_colours)+theme_light()+theme(legend.position = "none")+labs(x="Average Winning Time in Front",y="Conf. Finals Prob.")+scale_y_continuous(breaks = c(0,0.5,1))

lr8 <- ggplot()+
    geom_point(data = all_seasons_info,aes(x=avg_wtif,y=as.numeric(finals),color=team))+geom_smooth(data = all_seasons_info,aes(x=avg_wtif,y=as.numeric(finals)),method=glm,method.args=list(family="binomial"),inherit.aes = FALSE,se=FALSE,color="#60606080",linewidth=2)+scale_color_manual(values = team_colours)+theme_light()+theme(legend.position = "none")+labs(x="Average Winning Time in Front",y="NBA Finals Prob.")+scale_y_continuous(breaks = c(0,0.5,1))

lr9 <- ggplot()+
    geom_point(data = all_seasons_info,aes(x=avg_wtif,y=as.numeric(title_win),color=team))+geom_smooth(data = all_seasons_info,aes(x=avg_wtif,y=as.numeric(title_win)),method=glm,method.args=list(family="binomial"),inherit.aes = FALSE,se=FALSE,color="#60606080",linewidth=2)+scale_color_manual(values = team_colours)+theme_light()+theme(legend.position = "none")+labs(x="Average Winning Time in Front",y="NBA Title Prob.")+scale_y_continuous(breaks = c(0,0.5,1))

grid.arrange(lr5,lr6,lr7,lr8,lr9,nrow=5)

```

From the spread of data, we can see that the model will be less confident in predicting success based on the average winning time in front, as many teams who have been very dominant in their wins fail to make the postseason. This is also seen in the progression though the playoffs, with the models predicting much lower probabilities of success for the higher average winning time in front for the later stages. To have a 99% chance of making the postseason, the model suggests that a team should lead (on average) for 90% of the games in which it wins. This level of dominant wins has not been seen in the 9 years analysed here. To get over a 50% chance of making the conference semifinals, a team should lead on average for 76% of the games in which they win. All the models for later rounds of the playoffs require much higher, unachievable, levels of dominance in order for the model to suggest a greater than 50% chance. The losing time in front is a less accurate predictor of postseason success.

## Dominating But Not Winning = Inefficient?

Modelling with binomial regression shows that the win percentage of a team is a good predictor of reaching the postseason and a reasonable predictor of success within the postseason. This is to be expected, given that winning games is how a team achieves success. Analysis of the winning time in front shows that while it is correlated with win percentage, it is less effective at predicting how well a team will fair in the postseason. This is perhaps counter-intuitive, as we may expect that successful teams dominate games, spending the overwhelming majority of games in the lead, particularly given how frequent scoring is in basketball. Together this disconnect suggests that basketball is a very even sport, where even very successful teams will not be able to control most games, but rather ensure they win games by leading when it matters, at the end of the game. This does raise the possibility that basketball is not an efficient sport, where the teams who triumph at the end of the season are not necessarily the most dominant teams, although this unpredictability is often what fans relish in a sport.

## References

Graphs made with ggplot2 [@tidyverse] and gridExtra [@gridExtra]. Data retrieved and analysed using hoopR [@hoopR].

::: {#refs}
:::
